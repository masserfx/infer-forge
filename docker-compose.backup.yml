# Docker Compose extension for automated database backups
# Usage: docker compose -f docker-compose.yml -f docker-compose.backup.yml up -d

services:
  backup:
    image: postgres:16-alpine
    container_name: infer-forge-backup
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_USER=${POSTGRES_USER:-infer}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-infer}
      - POSTGRES_DB=${POSTGRES_DB:-infer_forge}
      - BACKUP_DIR=/backups
      - RETENTION_DAYS=30
    volumes:
      - ./scripts/backup_db.sh:/backup.sh:ro
      - backup-data:/backups
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache bash
        echo "Backup scheduler started. First backup in 60 seconds..."
        sleep 60
        while true; do
          echo "[$(date)] Running backup..."
          /backup.sh
          echo "[$(date)] Backup complete. Next backup in 24 hours."
          sleep 86400
        done
    depends_on:
      - db
    restart: unless-stopped

volumes:
  backup-data:
    driver: local
